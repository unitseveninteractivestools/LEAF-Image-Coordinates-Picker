<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAF | Image Coordinates Picker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .editor-section, .preview-section, .xml-section {
            flex: 1;
            min-width: 300px;
            background-color: #16213e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .preview-section {
            flex: 2;
            min-width: 500px;
        }
        
        h1 {
            color: #4cc9f0;
            margin-bottom: 10px;
            text-align: center;
            width: 100%;
        }
        
        h2 {
            color: #72efdd;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2d4059;
        }
        
        .description {
            color: #b8b8b8;
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .ui-container-wrapper {
            position: relative;
            width: 100%;
            background-color: #0f3460;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid #2d4059;
        }
        
        .ui-container {
            position: relative;
            width: 800px;
            height: 1000px;
            margin: 0 auto;
            overflow: hidden;
            background-color: rgba(15, 52, 96, 0.8);
        }
        
        .ui-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 0;
            opacity: 0.8;
        }
        
        .ui-background-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 1;
            pointer-events: none;
        }
        
        .button {
            position: absolute;
            background-color: rgba(76, 201, 240, 0.7);
            border: 3px dashed #4cc9f0;
            border-radius: 6px;
            cursor: move;
            z-index: 2;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .button:hover {
            background-color: rgba(76, 201, 240, 0.85);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .button.active {
            background-color: rgba(114, 239, 221, 0.8);
            border: 3px solid #72efdd;
            border-style: solid;
            z-index: 3;
        }
        
        .button.resizing {
            border: 3px solid #f47272;
        }
        
        .button-content {
            padding: 10px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .button-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1a1a2e;
            font-size: 14px;
        }
        
        .button-cmd {
            font-size: 11px;
            color: #0f3460;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        
        .button-coords {
            font-size: 10px;
            color: #555;
            margin-top: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #72efdd;
            border: 2px solid #1a1a2e;
            border-radius: 50%;
            z-index: 4;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }
        
        .resize-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: nesw-resize;
        }
        
        .resize-handle.ne {
            top: -6px;
            right: -6px;
            cursor: nesw-resize;
        }
        
        .resize-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nwse-resize;
        }
        
        .resize-handle.e {
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle.w {
            top: 50%;
            left: -6px;
            transform: translateY(-50%);
            cursor: ew-resize;
        }
        
        .resize-handle.n {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            cursor: ns-resize;
        }
        
        .resize-handle.s {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            cursor: ns-resize;
        }
        
        .button.active .resize-handle {
            opacity: 1;
        }
        
        .xml-output {
            width: 100%;
            height: 400px;
            background-color: #0a1931;
            color: #72efdd;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-y: auto;
            line-height: 1.4;
            margin-top: 10px;
            border: 1px solid #2d4059;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #2d4059;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            margin-bottom: 5px;
            color: #b8b8b8;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        
        .coord-value {
            color: #72efdd;
            font-family: monospace;
        }
        
        input, select, button {
            padding: 8px 12px;
            background-color: #0a1931;
            border: 1px solid #2d4059;
            border-radius: 4px;
            color: #e6e6e6;
            font-size: 0.9rem;
        }
        
        input[type="number"] {
            width: 100%;
        }
        
        button {
            background-color: #4cc9f0;
            color: #1a1a2e;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #72efdd;
        }
        
        .image-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .image-url-input {
            flex: 1;
        }
        
        .button-list {
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .button-item {
            padding: 10px 12px;
            background-color: #0a1931;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #4cc9f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .button-item:hover {
            background-color: #0f3460;
        }
        
        .button-item.active {
            border-left-color: #72efdd;
            background-color: #0f3460;
        }
        
        .button-item-title {
            font-weight: bold;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }
        
        .button-item-id {
            color: #72efdd;
            font-size: 0.8rem;
        }
        
        .button-item-cmd {
            font-size: 0.8rem;
            color: #b8b8b8;
            margin-bottom: 3px;
        }
        
        .instructions {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .instructions h3 {
            color: #72efdd;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .coord-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            background-color: rgba(10, 25, 49, 0.5);
            padding: 10px;
            border-radius: 4px;
        }
        
        .coord-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }
        
        .coord-label {
            color: #b8b8b8;
        }
        
        .coord-value {
            color: #72efdd;
            font-family: monospace;
            font-weight: bold;
        }
        
        .size-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .preview-section {
                min-width: 100%;
            }
            
            .ui-container {
                width: 100%;
                height: 800px;
            }
        }
    </style>
</head>
<body>
    <h1>LEAF | Image Coordinates Picker</h1>
    <p class="description">Drag buttons to reposition, use resize handles to adjust size. Upload or enter an image URL for reference. Coordinates update in real-time.</p>
    
    <div class="container">
        <div class="editor-section">
            <h2>Button Properties</h2>
            <div class="controls">
                <div class="control-group full-width">
                    <label for="selectedButton">Selected Button <span id="buttonIdDisplay" class="coord-value">-</span></label>
                    <select id="selectedButton">
                        <option value="">Select a button to edit</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="buttonLabel">Button Label</label>
                    <input type="text" id="buttonLabel" placeholder="Enter button label">
                </div>
                
                <div class="control-group">
                    <label for="buttonCommand">Command</label>
                    <input type="text" id="buttonCommand" placeholder="e.g., level.start level:credits">
                </div>
                
                <div class="control-group full-width">
                    <div class="coord-display">
                        <div class="coord-item">
                            <span class="coord-label">X Position:</span>
                            <span id="coordX" class="coord-value">0</span>
                        </div>
                        <div class="coord-item">
                            <span class="coord-label">Y Position:</span>
                            <span id="coordY" class="coord-value">0</span>
                        </div>
                        <div class="coord-item">
                            <span class="coord-label">Width:</span>
                            <span id="coordWidth" class="coord-value">0</span>
                        </div>
                        <div class="coord-item">
                            <span class="coord-label">Height:</span>
                            <span id="coordHeight" class="coord-value">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="control-group full-width">
                    <div class="size-controls">
                        <div class="control-group">
                            <label for="widthInput">Width <span class="coord-value">px</span></label>
                            <input type="number" id="widthInput" min="10" step="1">
                        </div>
                        
                        <div class="control-group">
                            <label for="heightInput">Height <span class="coord-value">px</span></label>
                            <input type="number" id="heightInput" min="10" step="1">
                        </div>
                    </div>
                </div>
                
                <div class="control-group full-width">
                    <label for="coordsOutput">Coordinates (for XML)</label>
                    <input type="text" id="coordsOutput" readonly>
                </div>
                
                <div class="control-group">
                    <button id="resetButton">Reset All Buttons</button>
                </div>
                
                <div class="control-group">
                    <button id="addButton">Add New Button</button>
                </div>
            </div>
            
            <div class="button-list" id="buttonList">
                <!-- Button list will be displayed here -->
            </div>
        </div>
        
        <div class="preview-section">
            <h2>UI Preview</h2>
            <div class="image-controls">
                <input type="text" id="imageUrl" class="image-url-input" placeholder="Enter image URL for reference (optional)">
                <button id="loadImage">Load Image</button>
                <button id="clearImage">Clear Image</button>
            </div>
            
            <div class="ui-container-wrapper">
                <div class="ui-container" id="uiContainer">
                    <img id="backgroundImage" class="ui-background-image" src="" alt="Background Reference">
                    <div class="ui-background-grid"></div>
                    <!-- Buttons will be dynamically added here -->
                </div>
            </div>
            
            <div class="instructions">
                <h3>How to use:</h3>
                <ul>
                    <li><strong>Drag</strong>: Click and drag buttons to reposition them</li>
                    <li><strong>Resize</strong>: Use the round handles on button edges/corners to resize (visible when button is selected)</li>
                    <li><strong>Select</strong>: Click on a button to select it for editing</li>
                    <li><strong>Image Reference</strong>: Enter an image URL to load a background reference</li>
                    <li><strong>Coordinates</strong>: Button coordinates update in real-time as you move/resize</li>
                </ul>
            </div>
        </div>
        
        <div class="xml-section">
            <h2>Generated XML</h2>
            <div class="xml-output" id="xmlOutput">
                <!-- XML will be displayed here -->
            </div>
            
            <div class="instructions">
                <h3>XML Structure:</h3>
                <p>The XML follows the format:</p>
                <pre style="margin-top: 10px; background: #0a1931; padding: 10px; border-radius: 4px; font-size: 0.8rem;">
&lt;ui texture="menu_more.png" selected="menu_more_select.png"&gt;
    &lt;rect coords="x1 y1 x2 y2" cmd="command"/&gt;
    &lt;rect coords="x1 y1 x2 y2" cmd="command"/&gt;
    &lt;outside cmd="script:hidemore"/&gt;
&lt;/ui&gt;</pre>
                <p>Where (x1, y1) is top-left and (x2, y2) is bottom-right corner.</p>
            </div>
        </div>
    </div>

    <script>
        // Initial button data from the XML
        const initialButtons = [
            { id: 1, x: 235, y: 112, width: 536, height: 126, cmd: "level.start level:credits ; script:hidemore", label: "Credits" },
            { id: 2, x: 235, y: 239, width: 562, height: 125, cmd: "script:rate", label: "Rate" },
            { id: 3, x: 235, y: 365, width: 433, height: 124, cmd: "script:facebook", label: "Facebook" },
            { id: 4, x: 235, y: 490, width: 341, height: 124, cmd: "script:twitter", label: "Twitter" },
            { id: 5, x: 235, y: 615, width: 478, height: 124, cmd: "script:website", label: "Website" },
            { id: 6, x: 235, y: 740, width: 497, height: 124, cmd: "level.start level:moregames ; script:hidemore", label: "More Games" }
        ];

        let buttons = JSON.parse(JSON.stringify(initialButtons));
        let activeButtonId = null;
        let isDragging = false;
        let isResizing = false;
        let resizeDirection = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        
        // UI Container dimensions (matches the XML coordinate system)
        const containerWidth = 1000;
        const containerHeight = 1000;
        
        // Initialize the editor
        document.addEventListener('DOMContentLoaded', function() {
            renderButtons();
            updateXML();
            populateButtonDropdown();
            setupEventListeners();
            updateCoordsDisplay();
            
            // Set up default image (a placeholder UI mockup)
            document.getElementById('imageUrl').value = 'https://via.placeholder.com/800x1000/2d4059/ffffff?text=UI+Background+Reference';
        });
        
        // Render all buttons in the UI container
        function renderButtons() {
            const uiContainer = document.getElementById('uiContainer');
            
            // Clear existing buttons
            document.querySelectorAll('.button').forEach(btn => btn.remove());
            
            buttons.forEach(button => {
                const buttonElement = createButtonElement(button);
                uiContainer.appendChild(buttonElement);
            });
            
            updateButtonList();
        }
        
        // Create a button element with resize handles
        function createButtonElement(button) {
            const buttonElement = document.createElement('div');
            buttonElement.className = `button ${activeButtonId === button.id ? 'active' : ''}`;
            buttonElement.id = `button-${button.id}`;
            buttonElement.dataset.id = button.id;
            
            // Calculate position based on container dimensions
            const left = (button.x / containerWidth) * 100;
            const top = (button.y / containerHeight) * 100;
            const widthPercent = (button.width / containerWidth) * 100;
            const heightPercent = (button.height / containerHeight) * 100;
            
            buttonElement.style.left = `${left}%`;
            buttonElement.style.top = `${top}%`;
            buttonElement.style.width = `${widthPercent}%`;
            buttonElement.style.height = `${heightPercent}%`;
            
            buttonElement.innerHTML = `
                <div class="button-content">
                    <div class="button-title">${button.label}</div>
                    <div class="button-cmd">${button.cmd}</div>
                    <div class="button-coords">${button.x},${button.y} - ${button.x + button.width},${button.y + button.height}</div>
                </div>
                <div class="resize-handle nw"></div>
                <div class="resize-handle n"></div>
                <div class="resize-handle ne"></div>
                <div class="resize-handle w"></div>
                <div class="resize-handle e"></div>
                <div class="resize-handle sw"></div>
                <div class="resize-handle s"></div>
                <div class="resize-handle se"></div>
            `;
            
            // Add event listeners
            buttonElement.addEventListener('mousedown', startDrag);
            buttonElement.addEventListener('click', function(e) {
                if (!isDragging && !isResizing) {
                    selectButton(button.id);
                }
            });
            
            // Add resize handle listeners
            const resizeHandles = buttonElement.querySelectorAll('.resize-handle');
            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            
            return buttonElement;
        }
        
        // Start dragging (mouse)
        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const buttonId = parseInt(this.dataset.id);
            const button = buttons.find(b => b.id === buttonId);
            
            if (!button) return;
            
            isDragging = true;
            selectButton(buttonId);
            
            const rect = this.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            
            // Add global mouse move and end listeners
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
            
            // Prevent text selection during drag
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'grabbing';
        }
        
        // Handle dragging
        function doDrag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            const button = buttons.find(b => b.id === activeButtonId);
            if (!button) return;
            
            const container = document.getElementById('uiContainer');
            const containerRect = container.getBoundingClientRect();
            
            // Calculate new position
            let newX = e.clientX - containerRect.left - dragOffsetX;
            let newY = e.clientY - containerRect.top - dragOffsetY;
            
            // Constrain to container bounds
            const buttonWidthPx = (button.width / containerWidth) * containerRect.width;
            const buttonHeightPx = (button.height / containerHeight) * containerRect.height;
            
            newX = Math.max(0, Math.min(newX, containerRect.width - buttonWidthPx));
            newY = Math.max(0, Math.min(newY, containerRect.height - buttonHeightPx));
            
            // Convert to percentage and update button
            const percentX = (newX / containerRect.width) * 100;
            const percentY = (newY / containerRect.height) * 100;
            
            // Update button position
            const buttonElement = document.getElementById(`button-${button.id}`);
            buttonElement.style.left = `${percentX}%`;
            buttonElement.style.top = `${percentY}%`;
            
            // Convert back to coordinate system
            button.x = Math.round((percentX / 100) * containerWidth);
            button.y = Math.round((percentY / 100) * containerHeight);
            
            // Update UI
            updateCoordsDisplay();
            updateXML();
        }
        
        // Start resizing
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const buttonElement = e.target.closest('.button');
            if (!buttonElement) return;
            
            const buttonId = parseInt(buttonElement.dataset.id);
            const button = buttons.find(b => b.id === buttonId);
            
            if (!button) return;
            
            isResizing = true;
            selectButton(buttonId);
            
            // Determine resize direction from handle class
            if (e.target.classList.contains('nw')) resizeDirection = 'nw';
            else if (e.target.classList.contains('n')) resizeDirection = 'n';
            else if (e.target.classList.contains('ne')) resizeDirection = 'ne';
            else if (e.target.classList.contains('w')) resizeDirection = 'w';
            else if (e.target.classList.contains('e')) resizeDirection = 'e';
            else if (e.target.classList.contains('sw')) resizeDirection = 'sw';
            else if (e.target.classList.contains('s')) resizeDirection = 's';
            else if (e.target.classList.contains('se')) resizeDirection = 'se';
            
            // Add active class for visual feedback
            buttonElement.classList.add('resizing');
            
            // Add global mouse move and end listeners
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            
            // Prevent text selection during resize
            document.body.style.userSelect = 'none';
        }
        
        // Handle resizing
        function doResize(e) {
            if (!isResizing || !resizeDirection) return;
            
            e.preventDefault();
            const button = buttons.find(b => b.id === activeButtonId);
            if (!button) return;
            
            const buttonElement = document.getElementById(`button-${button.id}`);
            const container = document.getElementById('uiContainer');
            const containerRect = container.getBoundingClientRect();
            
            // Get current button position in pixels
            const buttonRect = buttonElement.getBoundingClientRect();
            const buttonLeft = buttonRect.left - containerRect.left;
            const buttonTop = buttonRect.top - containerRect.top;
            const buttonRight = buttonRect.right - containerRect.left;
            const buttonBottom = buttonRect.bottom - containerRect.top;
            
            // Mouse position relative to container
            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;
            
            // Minimum button size
            const minSize = 20;
            
            // Calculate new dimensions based on resize direction
            let newX = button.x;
            let newY = button.y;
            let newWidth = button.width;
            let newHeight = button.height;
            
            switch (resizeDirection) {
                case 'e':
                    newWidth = Math.max(minSize, Math.round((mouseX - buttonLeft) / containerRect.width * containerWidth));
                    break;
                case 'w':
                    const newRight = button.x + button.width;
                    newWidth = Math.max(minSize, Math.round((buttonRight - mouseX) / containerRect.width * containerWidth));
                    newX = Math.max(0, Math.min(newRight - newWidth, newRight - minSize));
                    break;
                case 's':
                    newHeight = Math.max(minSize, Math.round((mouseY - buttonTop) / containerRect.height * containerHeight));
                    break;
                case 'n':
                    const newBottom = button.y + button.height;
                    newHeight = Math.max(minSize, Math.round((buttonBottom - mouseY) / containerRect.height * containerHeight));
                    newY = Math.max(0, Math.min(newBottom - newHeight, newBottom - minSize));
                    break;
                case 'se':
                    newWidth = Math.max(minSize, Math.round((mouseX - buttonLeft) / containerRect.width * containerWidth));
                    newHeight = Math.max(minSize, Math.round((mouseY - buttonTop) / containerRect.height * containerHeight));
                    break;
                case 'sw':
                    const newRightSW = button.x + button.width;
                    newWidth = Math.max(minSize, Math.round((buttonRight - mouseX) / containerRect.width * containerWidth));
                    newX = Math.max(0, Math.min(newRightSW - newWidth, newRightSW - minSize));
                    newHeight = Math.max(minSize, Math.round((mouseY - buttonTop) / containerRect.height * containerHeight));
                    break;
                case 'ne':
                    const newBottomNE = button.y + button.height;
                    newWidth = Math.max(minSize, Math.round((mouseX - buttonLeft) / containerRect.width * containerWidth));
                    newHeight = Math.max(minSize, Math.round((buttonBottom - mouseY) / containerRect.height * containerHeight));
                    newY = Math.max(0, Math.min(newBottomNE - newHeight, newBottomNE - minSize));
                    break;
                case 'nw':
                    const newRightNW = button.x + button.width;
                    const newBottomNW = button.y + button.height;
                    newWidth = Math.max(minSize, Math.round((buttonRight - mouseX) / containerRect.width * containerWidth));
                    newX = Math.max(0, Math.min(newRightNW - newWidth, newRightNW - minSize));
                    newHeight = Math.max(minSize, Math.round((buttonBottom - mouseY) / containerRect.height * containerHeight));
                    newY = Math.max(0, Math.min(newBottomNW - newHeight, newBottomNW - minSize));
                    break;
            }
            
            // Apply constraints
            if (newX + newWidth > containerWidth) newWidth = containerWidth - newX;
            if (newY + newHeight > containerHeight) newHeight = containerHeight - newY;
            
            // Update button properties
            button.x = Math.max(0, Math.round(newX));
            button.y = Math.max(0, Math.round(newY));
            button.width = Math.max(minSize, Math.round(newWidth));
            button.height = Math.max(minSize, Math.round(newHeight));
            
            // Update button display
            const leftPercent = (button.x / containerWidth) * 100;
            const topPercent = (button.y / containerHeight) * 100;
            const widthPercent = (button.width / containerWidth) * 100;
            const heightPercent = (button.height / containerHeight) * 100;
            
            buttonElement.style.left = `${leftPercent}%`;
            buttonElement.style.top = `${topPercent}%`;
            buttonElement.style.width = `${widthPercent}%`;
            buttonElement.style.height = `${heightPercent}%`;
            
            // Update coordinates display
            const coordsElement = buttonElement.querySelector('.button-coords');
            coordsElement.textContent = `${button.x},${button.y} - ${button.x + button.width},${button.y + button.height}`;
            
            // Update UI
            updateCoordsDisplay();
            updateSizeInputs();
            updateXML();
        }
        
        // Stop dragging or resizing
        function stopDrag() {
            isDragging = false;
            
            // Remove global event listeners
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
            
            // Restore text selection
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            
            updateXML();
        }
        
        function stopResize() {
            isResizing = false;
            resizeDirection = null;
            
            // Remove active class
            const buttonElement = document.getElementById(`button-${activeButtonId}`);
            if (buttonElement) {
                buttonElement.classList.remove('resizing');
            }
            
            // Remove global event listeners
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            
            // Restore text selection
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            
            updateXML();
        }
        
        // Select a button for editing
        function selectButton(buttonId) {
            activeButtonId = buttonId;
            const button = buttons.find(b => b.id === buttonId);
            
            if (!button) return;
            
            // Update active state in UI
            document.querySelectorAll('.button').forEach(btn => {
                btn.classList.remove('active');
            });
            const buttonElement = document.getElementById(`button-${buttonId}`);
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Update form fields
            document.getElementById('selectedButton').value = buttonId;
            document.getElementById('buttonLabel').value = button.label;
            document.getElementById('buttonCommand').value = button.cmd;
            document.getElementById('buttonIdDisplay').textContent = `ID: ${buttonId}`;
            
            // Update size inputs
            updateSizeInputs();
            
            // Update button list
            document.querySelectorAll('.button-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.id) === buttonId) {
                    item.classList.add('active');
                }
            });
            
            // Update coordinates display
            updateCoordsDisplay();
        }
        
        // Update coordinates display
        function updateCoordsDisplay() {
            if (!activeButtonId) {
                document.getElementById('coordX').textContent = '0';
                document.getElementById('coordY').textContent = '0';
                document.getElementById('coordWidth').textContent = '0';
                document.getElementById('coordHeight').textContent = '0';
                document.getElementById('coordsOutput').value = '';
                return;
            }
            
            const button = buttons.find(b => b.id === activeButtonId);
            if (!button) return;
            
            document.getElementById('coordX').textContent = button.x;
            document.getElementById('coordY').textContent = button.y;
            document.getElementById('coordWidth').textContent = button.width;
            document.getElementById('coordHeight').textContent = button.height;
            
            // Update coordinates output for XML
            const coords = `${button.x} ${button.y} ${button.x + button.width} ${button.y + button.height}`;
            document.getElementById('coordsOutput').value = coords;
        }
        
        // Update size inputs
        function updateSizeInputs() {
            if (!activeButtonId) return;
            
            const button = buttons.find(b => b.id === activeButtonId);
            if (!button) return;
            
            document.getElementById('widthInput').value = button.width;
            document.getElementById('heightInput').value = button.height;
        }
        
        // Generate and display the XML
        function updateXML() {
            let xml = '<ui texture="menu_more.png" selected="menu_more_select.png">\n';
            
            buttons.forEach(button => {
                const coords = `${button.x} ${button.y} ${button.x + button.width} ${button.y + button.height}`;
                xml += `\t<rect coords="${coords}"\tcmd="${button.cmd}"/>\n`;
            });
            
            xml += '\t<outside cmd="script:hidemore"/>\n';
            xml += '</ui>';
            
            document.getElementById('xmlOutput').textContent = xml;
            
            // Update button list as well
            updateButtonList();
        }
        
        // Update the button list display
        function updateButtonList() {
            const buttonList = document.getElementById('buttonList');
            buttonList.innerHTML = '';
            
            buttons.forEach(button => {
                const buttonItem = document.createElement('div');
                buttonItem.className = `button-item ${activeButtonId === button.id ? 'active' : ''}`;
                buttonItem.dataset.id = button.id;
                
                buttonItem.innerHTML = `
                    <div class="button-item-title">
                        <span>${button.label}</span>
                        <span class="button-item-id">#${button.id}</span>
                    </div>
                    <div class="button-item-cmd">${button.cmd}</div>
                    <div class="button-coords">${button.x} ${button.y} ${button.x + button.width} ${button.y + button.height}</div>
                `;
                
                buttonItem.addEventListener('click', () => {
                    selectButton(button.id);
                });
                
                buttonList.appendChild(buttonItem);
            });
        }
        
        // Populate the button dropdown
        function populateButtonDropdown() {
            const select = document.getElementById('selectedButton');
            select.innerHTML = '<option value="">Select a button to edit</option>';
            
            buttons.forEach(button => {
                const option = document.createElement('option');
                option.value = button.id;
                option.textContent = `${button.label} (${button.id})`;
                select.appendChild(option);
            });
            
            if (activeButtonId) {
                select.value = activeButtonId;
            }
        }
        
        // Set up event listeners for form controls
        function setupEventListeners() {
            // Button selection dropdown
            document.getElementById('selectedButton').addEventListener('change', function() {
                const buttonId = parseInt(this.value);
                if (buttonId) {
                    selectButton(buttonId);
                }
            });
            
            // Button label input
            document.getElementById('buttonLabel').addEventListener('input', function() {
                if (activeButtonId) {
                    const button = buttons.find(b => b.id === activeButtonId);
                    if (button) {
                        button.label = this.value;
                        
                        // Update button display
                        const buttonElement = document.getElementById(`button-${activeButtonId}`);
                        const titleElement = buttonElement.querySelector('.button-title');
                        titleElement.textContent = this.value;
                        
                        // Update dropdown
                        const option = document.querySelector(`#selectedButton option[value="${activeButtonId}"]`);
                        if (option) {
                            option.textContent = `${this.value} (${activeButtonId})`;
                        }
                        
                        updateButtonList();
                        updateXML();
                    }
                }
            });
            
            // Command input field
            document.getElementById('buttonCommand').addEventListener('input', function() {
                if (activeButtonId) {
                    const button = buttons.find(b => b.id === activeButtonId);
                    if (button) {
                        button.cmd = this.value;
                        
                        // Update button display
                        const buttonElement = document.getElementById(`button-${activeButtonId}`);
                        const cmdElement = buttonElement.querySelector('.button-cmd');
                        cmdElement.textContent = this.value;
                        
                        updateXML();
                    }
                }
            });
            
            // Width input
            document.getElementById('widthInput').addEventListener('input', function() {
                if (activeButtonId) {
                    const button = buttons.find(b => b.id === activeButtonId);
                    if (button && this.value >= 10) {
                        button.width = parseInt(this.value);
                        
                        // Update button display
                        const buttonElement = document.getElementById(`button-${activeButtonId}`);
                        const widthPercent = (button.width / containerWidth) * 100;
                        buttonElement.style.width = `${widthPercent}%`;
                        
                        // Update coordinates display
                        const coordsElement = buttonElement.querySelector('.button-coords');
                        coordsElement.textContent = `${button.x},${button.y} - ${button.x + button.width},${button.y + button.height}`;
                        
                        updateCoordsDisplay();
                        updateXML();
                    }
                }
            });
            
            // Height input
            document.getElementById('heightInput').addEventListener('input', function() {
                if (activeButtonId) {
                    const button = buttons.find(b => b.id === activeButtonId);
                    if (button && this.value >= 10) {
                        button.height = parseInt(this.value);
                        
                        // Update button display
                        const buttonElement = document.getElementById(`button-${activeButtonId}`);
                        const heightPercent = (button.height / containerHeight) * 100;
                        buttonElement.style.height = `${heightPercent}%`;
                        
                        // Update coordinates display
                        const coordsElement = buttonElement.querySelector('.button-coords');
                        coordsElement.textContent = `${button.x},${button.y} - ${button.x + button.width},${button.y + button.height}`;
                        
                        updateCoordsDisplay();
                        updateXML();
                    }
                }
            });
            
            // Reset button
            document.getElementById('resetButton').addEventListener('click', function() {
                if (confirm('Reset all buttons to their original positions?')) {
                    buttons = JSON.parse(JSON.stringify(initialButtons));
                    renderButtons();
                    updateXML();
                    populateButtonDropdown();
                    selectButton(1);
                }
            });
            
            // Add new button
            document.getElementById('addButton').addEventListener('click', function() {
                const newId = Math.max(...buttons.map(b => b.id)) + 1;
                const newButton = {
                    id: newId,
                    x: 100,
                    y: 100,
                    width: 200,
                    height: 80,
                    cmd: "script:new_command",
                    label: `Button ${newId}`
                };
                
                buttons.push(newButton);
                renderButtons();
                updateXML();
                populateButtonDropdown();
                selectButton(newId);
            });
            
            // Load image
            document.getElementById('loadImage').addEventListener('click', function() {
                const imageUrl = document.getElementById('imageUrl').value;
                if (imageUrl) {
                    const img = document.getElementById('backgroundImage');
                    img.src = imageUrl;
                    img.style.display = 'block';
                }
            });
            
            // Clear image
            document.getElementById('clearImage').addEventListener('click', function() {
                const img = document.getElementById('backgroundImage');
                img.src = '';
                img.style.display = 'none';
                document.getElementById('imageUrl').value = '';
            });
            
            // Enter key for image URL
            document.getElementById('imageUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loadImage').click();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Delete button
                if (e.key === 'Delete' && activeButtonId) {
                    if (buttons.length > 1) {
                        buttons = buttons.filter(b => b.id !== activeButtonId);
                        renderButtons();
                        updateXML();
                        populateButtonDropdown();
                        selectButton(buttons[0].id);
                    }
                }
                
                // Ctrl+R to reset
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    document.getElementById('resetButton').click();
                }
                
                // Arrow keys to move selected button
                if (activeButtonId && !isDragging && !isResizing) {
                    const button = buttons.find(b => b.id === activeButtonId);
                    if (button) {
                        const step = e.shiftKey ? 10 : 1;
                        
                        switch(e.key) {
                            case 'ArrowLeft':
                                button.x = Math.max(0, button.x - step);
                                break;
                            case 'ArrowRight':
                                button.x = Math.min(containerWidth - button.width, button.x + step);
                                break;
                            case 'ArrowUp':
                                button.y = Math.max(0, button.y - step);
                                break;
                            case 'ArrowDown':
                                button.y = Math.min(containerHeight - button.height, button.y + step);
                                break;
                        }
                        
                        if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                            e.preventDefault();
                            renderButtons();
                            updateCoordsDisplay();
                            updateXML();
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
